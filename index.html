<style>

body {
  margin: 0;
  font-family: sans-serif;
}

body > progress {
  position: fixed;
  inset: 0;
  display: block;
  width: 50vw;
  margin: calc(50vh - 0.5em) 25vw;
}

body > progress ~ * {
  display: none;
}

main {
  max-width: 500px;
  margin: 0 auto;
  padding: 1em 2em 5em;
}

main h1 {
  text-align: center;
}

main progress {
  vertical-align: middle;
  visibility: hidden;
}

main input[type="file"] {
  display: block;
  margin-bottom: 0.5em;
}

main textarea {
  display: block;
  width: 100%;
  min-height: 8em;
  font-family: monospace;
  resize: vertical;
}

main code {
  font-size: 90%;
}

main .output {
  width: 100%;
  margin-top: 1em;
}

</style>

<progress></progress>
<main>
  <h1>Web5</h1>
  <section id="did-create">
    <h1>Create a Decentralized Identifier (DID)</h1>
    <div class="input">
      <pre><code>const did = await web5.did.create('ion');</code></pre>
      <button>Run!</button>
    </div>
    <div class="output">
      <details>
        <summary>
          <code>Hit "Run" above to create DID</code>
        </summary>
        <textarea></textarea>
      </details>
    </div>
  </section>
  <section id="did-register">
    <h1>Store DID</h1>
    <div class="input">
      <pre><code>
        await web5.did.manager.set(did.id, {
          connected: true,
          endpoint: 'app://dwn',
          keys: {
            ['#dwn']: {
              keyPair: did.keys.find(key => key.id === 'dwn').keyPair,
            },
          },
        });
</code></pre>
  <button disabled>Run!</button>
  </div>
    <div class="output"></div>
  </section>
  <section id="dwn-write">
    <h1>Write some data</h1>
    <div class="input">
      <pre><code>
      const {record} = await web5.dwn.records.write(did.id, {
        author: did.id,
        data: "Hello Web5",
        message: {
          dataFormat: 'text/plain',
        },
      });
      </code></pre>
      <input type="text" placeholder="Enter text" disabled>
      <button disabled>Run!</button>
      <progress></progress>
    </div>
    <div class="output">
      <details>
        <summary>...</summary>
        <textarea readonly></textarea>
      </details>
    </div>
  </section>
  <section id="dwn-read">
    <h1>Read the data</h1>
    <div class="input">
      <pre><code>
        const readResult = await record.data.text();
    </code></pre>
      <button disabled>Run!</button>
      <progress></progress>
    </div>
    <div class="output"></div>
  </section>
  <section id="dwn-update">
    <h1>Update the message</h1>
    <div class="input">
      <pre><code>
        const updateResult = await record.update({data: "Hello, I'm updated!"});
      </code></pre>
      <input type="text" placeholder="Update text" disabled>
      <button disabled>Run!</button>
      <progress></progress>
    </div>
    <div class="output"></div>
  </section>
  <section id="dwn-delete">
    <h1>Delete the message</h1>
    <div class="input">
      <pre><code>
        const deleteResult = await record.delete();
      </code></pre>
      <button disabled>Run!</button>
      <progress></progress>
    </div>
    <div class="output">
      <details>
        <summary>...</summary>
        <textarea readonly></textarea>
      </details>
    </div>
  </section>
</main>

<script type="module">

/* ========================== */
/* ========== Web5 ========== */

import { Web5 } from 'https://cdn.jsdelivr.net/npm/@tbd54566975/web5@0.6.0/dist/browser.mjs';

let web5 = new Web5;

async function didCreate() {
  let did = await web5.did.create('ion');
  return did;
};

async function didRegister(did) {
  await web5.did.manager.set(did.id, {
    connected: true,
    endpoint: 'app://dwn',
    keys: {
      ['#dwn']: {
        keyPair: did.keys.find(key => key.id === 'dwn').keyPair,
      },
    },
  });
};

async function dwnWriteTextRecord(did, data) {
  let result = await web5.dwn.records.write(did.id, {
    author: did.id,
    data,
    message: {
      dataFormat: 'text/plain',
    },
  });
  return result;
}

async function dwnUpdateDataFromRecordWithId(record, data) {
  await record.update({data});
  return await record.data.text();
}

async function dwnReadDataFromRecordWithId(record) {
  return await record.data.text();
}

async function dwnDeleteRecordWithId(record) {
  return await record.delete();
}

/* ========== Web5 ========== */
/* ========================== */


document.querySelector('progress').remove();

let didCreateInputButton = document.querySelector('#did-create .input button');
let didCreateOutputSummaryCode = document.querySelector('#did-create .output details summary code');
let didCreateOutputDetailsTextarea = document.querySelector('#did-create .output details textarea');
let did = null;

let didRegisterInputButton = document.querySelector('#did-register .input button');
let didRegisterOutput = document.querySelector('#did-register .output');
let registered = false;

let dwnWriteInputFile = document.querySelector('#dwn-write .input input[type="text"]');
let dwnWriteInputButton = document.querySelector('#dwn-write .input button');
let dwnWriteInputProgress = document.querySelector('#dwn-write .input progress');
let dwnWriteOutputSummary = document.querySelector('#dwn-write .output details summary');
let dwnWriteOutputDetailsTextarea = document.querySelector('#dwn-write .output details textarea');
let writeResults = [ ];

let dwnReadInputButton = document.querySelector('#dwn-read .input button');
let dwnReadInputProgress = document.querySelector('#dwn-read .input progress');
let dwnReadOutput = document.querySelector('#dwn-read .output');

let dwnUpdateInputFile = document.querySelector('#dwn-update .input input[type="text"]');
let dwnUpdateInputButton = document.querySelector('#dwn-update .input button');
let dwnUpdateOutput = document.querySelector('#dwn-update .output');

let dwnDeleteInputButton = document.querySelector('#dwn-delete .input button');
let dwnDeleteInputProgress = document.querySelector('#dwn-delete .input progress');
let dwnDeleteOutputSummary = document.querySelector('#dwn-delete .output details summary');
let dwnDeleteOutputDetailsTextarea = document.querySelector('#dwn-delete .output details textarea');
let deleteResults = [ ];

function update() {
  if (!did) {
    registered = false;
  }

  if (!registered) {
    writeResults = [ ];
  }

  if (document.activeElement !== didCreateOutputDetailsTextarea) {
    didCreateOutputSummaryCode.innerHTML = did?.internalId;
    didCreateOutputDetailsTextarea.value = did ? JSON.stringify(did, null, 2) : '';
  }

  didRegisterInputButton.disabled = !did || registered;
  didRegisterOutput.innerHTML = registered ? '&#x2714; Registered!' : '';

  dwnWriteInputFile.disabled = !registered;
  dwnWriteInputButton.disabled = !registered || !dwnWriteInputFile.files.length;
  dwnWriteOutputSummary.innerHTML = writeResults.length ? '&#x2714; Written!' : '...';
  dwnWriteOutputDetailsTextarea.value = writeResults.length ? JSON.stringify(writeResults, null, 2) : '';

  dwnReadInputButton.disabled = deleteResults.length;

  dwnDeleteInputButton.disabled = deleteResults.length;
  dwnDeleteOutputSummary.innerHTML = deleteResults.length ? `&#x2714; Deleted ${deleteResults.length} entries!` : '...';
  dwnDeleteOutputDetailsTextarea.value = deleteResults.length ? JSON.stringify(deleteResults, null, 2) : '';
}

didCreateInputButton.addEventListener('click', async () => {
  did = await didCreate();

  registered = false;
  update();
});
didCreateOutputDetailsTextarea.addEventListener('input', () => {
  try {
    did = JSON.parse(didCreateOutputDetailsTextarea.value);
  } catch {
    did = null;
  }

  registered = false;
  update();
});

didRegisterInputButton.addEventListener('click', async () => {
  await didRegister(did);
  registered = true;

  update();
});

dwnWriteInputFile.addEventListener('input', () => {
  writeResults = [ ];
  update();
});

dwnWriteInputButton.addEventListener('click', async () => {
  dwnWriteInputButton.disabled = true;
  dwnWriteInputProgress.style.visibility = 'visible';
  dwnWriteOutputSummary.innerHTML = '...';
  dwnWriteOutputDetailsTextarea.value = '';

  writeResults = [ ];
    let result = await dwnWriteTextRecord(did, data);
    writeResults.push(result);

    dwnWriteInputButton.disabled = false;
    dwnWriteInputProgress.style.visibility = 'hidden';

    update();
});

dwnUpdateInputButton.addEventListener('click', async () => {
  dwnUpdateInputButton.disabled = true;
  dwnUpdateInputProgress.style.visibility = 'visible';

  let result = await dwnUpdateDataFromRecordWithId(writeResults[0], dwnUpdateInputFile.value)
  
  dwnUpdateOutput.innerHTML = result
  dwnUpdateInputButton.disabled = false;
  dwnUpdateInputProgress.style.visibility = 'hidden';

  update();
});

dwnReadInputButton.addEventListener('click', async () => {
  dwnReadInputButton.disabled = true;
  dwnReadInputProgress.style.visibility = 'visible';

  dwnReadOutput.innerHTML = '';
  let result = await dwnReadDataFromRecordWithId(writeResults[0]);

  dwnReadInputButton.disabled = false;
  dwnReadInputProgress.style.visibility = 'hidden';

  update();
});

dwnDeleteInputButton.addEventListener('click', async () => {
  dwnDeleteInputButton.disabled = true;
  dwnDeleteInputProgress.style.visibility = 'visible';
  dwnDeleteOutputSummary.innerHTML = '...';
  dwnDeleteOutputDetailsTextarea.value = '';

  deleteResults = [ ];
  let result = await dwnDeleteRecordWithId(writeResults[0]);
  deleteResults.push(result);
  dwnDeleteInputProgress.style.visibility = 'hidden';

  update();
});

</script>
